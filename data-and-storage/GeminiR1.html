<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Gemini 2.5 Toggle</title>
    <style>
        /* R1 Screen Dimensions: 240px x 282px */
        :root {
            --bg: #000000;
            --text: #ffffff;
            --accent: #00ff9d; /* Sci-fi Green */
            --recording: #ff3b30; /* Bright Red */
            --bubble-ai: #1a1a1a;
            --bubble-user: #333333;
        }

        * {
            box-sizing: border-box;
            user-select: none;
        }

        body {
            margin: 0;
            padding: 0;
            width: 240px;
            height: 282px;
            background-color: var(--bg);
            color: var(--text);
            font-family: 'Courier New', monospace;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            transition: border 0.2s;
            border: 2px solid transparent;
        }

        /* Visual State: Recording */
        body.listening {
            border: 4px solid var(--recording);
        }

        /* Header */
        #header {
            height: 24px;
            background: #111;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 8px;
            border-bottom: 1px solid #333;
            font-size: 10px;
            font-weight: bold;
        }

        #status {
            color: #666;
            text-transform: uppercase;
        }
        
        body.listening #status { color: var(--recording); }

        /* Chat Area */
        #chat-view {
            flex: 1;
            overflow-y: hidden; /* Manual scroll only */
            padding: 8px;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .msg {
            padding: 6px 8px;
            border-radius: 6px;
            font-size: 11px;
            line-height: 1.3;
            max-width: 95%;
            word-wrap: break-word;
            animation: fadein 0.2s;
        }

        .ai {
            background: var(--bubble-ai);
            align-self: flex-start;
            border-left: 2px solid var(--accent);
            color: #ddd;
        }

        .user {
            background: var(--bubble-user);
            align-self: flex-end;
            text-align: right;
            color: #fff;
        }

        .sys {
            font-size: 9px;
            color: #555;
            text-align: center;
            align-self: center;
            font-style: italic;
        }

        /* Footer / Instruction */
        #footer {
            height: 26px;
            background: #111;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 9px;
            color: #888;
            border-top: 1px solid #333;
        }

        @keyframes fadein { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

    <div id="header">
        <span>GEMINI 2.5</span>
        <span id="status">IDLE</span>
    </div>

    <div id="chat-view">
        <div class="msg sys">Scroll Wheel to read history</div>
        <div class="msg ai">Click Side Button once to start listening. Click again to send.</div>
    </div>

    <div id="footer">
        CLICK SIDE BUTTON TO CHAT
    </div>

    <!-- Hidden Input for Speech API buffer -->
    <input type="text" id="buffer" style="display:none;">

    <script>
        // --- CONFIGURATION ---
        const API_KEY = "AIzaSyAyu53MaE3q8Uqee5CzmI0PiNtKUwQV8zc";
        const MODEL = "gemini-2.5-flash";
        const URL = `https://generativelanguage.googleapis.com/v1beta/models/${MODEL}:generateContent?key=${API_KEY}`;

        // --- DOM ---
        const chatView = document.getElementById('chat-view');
        const statusLabel = document.getElementById('status');
        const footerLabel = document.getElementById('footer');
        const buffer = document.getElementById('buffer');

        // --- STATE ---
        let isRecording = false;
        let recognition;
        let silenceTimer;

        // --- R1 HARDWARE EVENTS ---

        // 1. SCROLL WHEEL (Navigation)
        window.addEventListener("scrollUp", () => {
            chatView.scrollTop -= 50;
        });

        window.addEventListener("scrollDown", () => {
            chatView.scrollTop += 50;
        });

        // 2. SIDE BUTTON (Toggle Logic)
        window.addEventListener("sideClick", () => {
            toggleRecording();
        });

        // Keyboard fallback for testing on PC (Spacebar)
        document.addEventListener('keydown', (e) => {
            if(e.code === "Space") toggleRecording();
        });

        // --- SPEECH RECOGNITION SETUP ---
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;

        if (SpeechRecognition) {
            recognition = new SpeechRecognition();
            recognition.continuous = true; 
            recognition.interimResults = true;
            recognition.lang = 'en-US';

            recognition.onstart = () => {
                // UI Updates handle in toggle function
                console.log("Mic Active");
            };

            recognition.onresult = (event) => {
                let transcript = "";
                for (let i = event.resultIndex; i < event.results.length; ++i) {
                    transcript += event.results[i][0].transcript;
                }
                buffer.value = transcript;
                footerLabel.innerText = transcript.substring(0, 25) + "..."; // Live preview in footer
            };
            
            recognition.onerror = (e) => {
                console.error(e);
                resetUI();
            };
        } else {
            addMsg("System Error: Speech API missing.", "sys");
        }

        // --- LOGIC ---

        function toggleRecording() {
            if (!recognition) return;

            if (!isRecording) {
                // START LISTENING
                try {
                    buffer.value = ""; // Clear old text
                    recognition.start();
                    isRecording = true;
                    
                    // UI Updates
                    document.body.classList.add('listening');
                    statusLabel.innerText = "REC";
                    footerLabel.innerText = "LISTENING...";
                    window.speechSynthesis.cancel(); // Stop AI from talking if user interrupts
                } catch (e) {
                    console.log("Stream error", e);
                }
            } else {
                // STOP AND SEND
                recognition.stop();
                isRecording = false;

                // UI Updates
                document.body.classList.remove('listening');
                statusLabel.innerText = "SENDING";
                footerLabel.innerText = "PROCESSING...";

                // Small delay to ensure final transcript is captured
                setTimeout(() => {
                    const text = buffer.value.trim();
                    if (text) {
                        handleInteraction(text);
                    } else {
                        resetUI();
                        addMsg("I didn't hear anything.", "sys");
                    }
                }, 200);
            }
        }

        function resetUI() {
            isRecording = false;
            document.body.classList.remove('listening');
            statusLabel.innerText = "IDLE";
            footerLabel.innerText = "CLICK SIDE BUTTON TO CHAT";
        }

        async function handleInteraction(text) {
            addMsg(text, "user");
            
            try {
                const reply = await fetchGemini(text);
                addMsg(reply, "ai");
                speak(reply);
            } catch (e) {
                addMsg("Error: " + e.message, "sys");
            }
            
            resetUI();
        }

        // --- GEMINI API ---
        async function fetchGemini(prompt) {
            try {
                const response = await fetch(URL, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: prompt }] }]
                    })
                });

                if (!response.ok) throw new Error(response.status);
                
                const data = await response.json();
                return data.candidates[0].content.parts[0].text;
            } catch (error) {
                return "Connection failed. Check API Key.";
            }
        }

        // --- UTILITIES ---
        function addMsg(text, type) {
            const div = document.createElement('div');
            div.className = `msg ${type}`;
            // Format bold text
            div.innerHTML = text.replace(/\*\*(.*?)\*\*/g, '<b>$1</b>');
            chatView.appendChild(div);
            chatView.scrollTop = chatView.scrollHeight; // Auto scroll to bottom
        }

        function speak(text) {
            if (!window.speechSynthesis) return;
            window.speechSynthesis.cancel();
            const cleanText = text.replace(/[*#]/g, '');
            const u = new SpeechSynthesisUtterance(cleanText);
            u.rate = 1.1;
            window.speechSynthesis.speak(u);
        }
    </script>
</body>
</html>
