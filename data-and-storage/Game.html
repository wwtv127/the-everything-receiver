<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simple Platformer</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap');
        body {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
            background-color: #2c3e50;
            font-family: 'Inter', sans-serif;
            color: #ecf0f1;
            flex-direction: column;
            overflow: hidden;
            user-select: none; /* Prevent text selection on mobile */
        }

        .game-container {
            position: relative;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
            border-radius: 12px;
            overflow: hidden;
        }

        canvas {
            background-color: #34495e;
            display: block;
            border-radius: 12px;
        }

        .message-box {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: rgba(44, 62, 80, 0.9);
            padding: 30px;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.4);
            transition: opacity 0.3s ease;
            z-index: 10;
            display: flex;
            flex-direction: column;
            align-items: center;
            /* New responsive styles */
            max-width: 90%;
            width: auto;
            box-sizing: border-box;
        }

        #patty-logo {
            /* Updated responsive styles for smaller screens */
            width: 30%; /* Made it significantly smaller */
            max-width: 150px; /* Prevent it from getting too big */
            height: auto;
            margin-bottom: 20px;
        }

        h1 {
            /* New responsive styles */
            font-size: clamp(1.5em, 5vw, 2.5em);
            margin-bottom: 10px;
        }

        p {
            /* New responsive styles */
            font-size: clamp(1em, 2vw, 1.2em);
            margin: 5px 0;
        }

        .hidden {
            opacity: 0;
            pointer-events: none;
        }
        
        .loading-button {
            display: none;
        }

        .on-screen-controls {
            display: flex;
            justify-content: space-around;
            width: 100%;
            position: absolute;
            bottom: 20px;
            left: 0;
            z-index: 5;
            padding: 0 20px;
            box-sizing: border-box;
        }
        
        /* The media query below has been removed to ensure the controls are always visible.
        @media (min-width: 768px) {
            .on-screen-controls {
                display: none;
            }
        }
        */

        .control-button {
            width: 60px;
            height: 60px;
            background-color: #3498db;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 2em;
            color: #ecf0f1;
            cursor: pointer;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
            transition: transform 0.1s ease;
            -webkit-tap-highlight-color: transparent; /* Remove blue highlight on tap */
        }
        
        .control-button:active {
            transform: scale(0.95);
        }

        .start-button {
            padding: 15px 30px;
            font-size: 1.2em;
            font-weight: bold;
            color: #ecf0f1;
            background-color: #3498db;
            border: none;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
            cursor: pointer;
            transition: background-color 0.2s ease, transform 0.1s ease;
        }

        .start-button:hover {
            background-color: #2980b9;
        }

        .start-button:active {
            transform: scale(0.98);
        }
    </style>
</head>
<body>
    <div class="game-container">
        <canvas id="gameCanvas"></canvas>
        <div id="messageBox" class="message-box">
            <img id="patty-logo" src="https://files.catbox.moe/m1uq1k.png" alt="Krabby Patty Logo">
            <h1>Loading...</h1>
            <p>Please wait...</p>
            <button id="startButton" class="start-button loading-button">Tap to Start</button>
        </div>
        <div class="on-screen-controls">
            <button id="leftButton" class="control-button">&larr;</button>
            <button id="jumpButton" class="control-button">&#x2191;</button>
            <button id="rightButton" class="control-button">&rarr;</button>
        </div>
    </div>
    
    <script>
        // Use Tone.js for simple sound effects
        const synth = new Tone.Synth().toDestination();
        const pattySynth = new Tone.Synth({
            oscillator: { type: "square" },
            envelope: {
                attack: 0.005,
                decay: 0.1,
                sustain: 0.05,
                release: 0.1
            }
        }).toDestination();

        // New synths for win and game over sounds
        const winSynth = new Tone.Synth({
            oscillator: { type: "sine" },
            envelope: {
                attack: 0.05,
                decay: 0.5,
                sustain: 0.2,
                release: 0.8
            }
        }).toDestination();
        
        const gameOverSynth = new Tone.Synth({
            oscillator: { type: "square" },
            envelope: {
                attack: 0.01,
                decay: 0.2,
                sustain: 0.1,
                release: 0.3
            }
        }).toDestination();
        
        // New synth for button clicks
        const buttonSynth = new Tone.Synth({
            oscillator: { type: "triangle" },
            envelope: {
                attack: 0.01,
                decay: 0.1,
                sustain: 0.1,
                release: 0.2
            }
        }).toDestination();

        // Setup canvas and context
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const messageBox = document.getElementById('messageBox');
        const startButton = document.getElementById('startButton');
        const pattyLogo = document.getElementById('patty-logo');
        
        // Load the character image
        const playerImage = new Image();
        playerImage.crossOrigin = "anonymous"; // Fix for cross-origin issues
        playerImage.src = 'https://files.catbox.moe/bxae5r.jpeg';
        let isPlayerImageLoaded = false;
        
        // Load the Krabby Patty image (for drawing, not the logo)
        const pattyImage = new Image();
        pattyImage.crossOrigin = "anonymous"; // Fix for cross-origin issues
        pattyImage.src = 'https://files.catbox.moe/m1uq1k.png';
        let isPattyImageLoaded = false;

        // Counter for loaded assets
        let assetsLoadedCount = 0;
        const totalAssets = 2; // playerImage and pattyImage

        function checkAssetsLoaded() {
            assetsLoadedCount++;
            if (assetsLoadedCount === totalAssets) {
                // All assets are loaded, show the plot screen
                showMessage("Oh no!", "The Krusty Krab has ran out of Krabby Patties. You need to help SpongeBob by collecting them throughout these levels!", "Continue");
                startButton.classList.remove('loading-button');
            }
        }
        
        playerImage.onload = () => {
            isPlayerImageLoaded = true;
            checkAssetsLoaded();
        };

        playerImage.onerror = () => {
            console.error("Failed to load player image from URL. The character will be a yellow square.");
            isPlayerImageLoaded = false;
            checkAssetsLoaded();
        };

        pattyImage.onload = () => {
            isPattyImageLoaded = true;
            checkAssetsLoaded();
        };

        pattyImage.onerror = () => {
            console.error("Failed to load Krabby Patty image from URL. The patties will be brown squares.");
            isPattyImageLoaded = false;
            checkAssetsLoaded();
        };

        // Set canvas dimensions responsively
        let canvasWidth;
        let canvasHeight;

        function setCanvasSize() {
            canvasWidth = Math.min(window.innerWidth * 0.9, 800);
            canvasHeight = Math.min(window.innerHeight * 0.7, 600);
            canvas.width = canvasWidth;
            canvas.height = canvasHeight;
        }
        
        // Listen for window resize to make the game responsive
        window.addEventListener('resize', () => {
            setCanvasSize();
            defineLevels();
            setupLevel(); // Re-position elements based on new size
            draw();
        });

        // Game state variables
        let isGameRunning = false;
        let score = 0;
        let currentLevelIndex = 0;
        let player = {
            x: 50,
            y: canvasHeight - 100,
            width: 30, // Adjusted to be smaller
            height: 40, // Adjusted to be smaller
            velocityY: 0,
            velocityX: 0,
            onGround: false
        };

        const gravity = 0.5;
        const jumpStrength = -12;
        const horizontalSpeed = 5;

        // Level data: platforms and Krabby Patties
        let levels = [];
        let platforms = [];
        let patties = [];
        let lava = [];
        
        function defineLevels() {
            levels = [
                // Level 1: Standard
                {
                    platforms: [
                        { x: 0, y: canvasHeight - 40, width: canvasWidth, height: 40 },
                        { x: canvasWidth * 0.2, y: canvasHeight * 0.75, width: canvasWidth * 0.25, height: 20 },
                        { x: canvasWidth * 0.55, y: canvasHeight * 0.55, width: canvasWidth * 0.2, height: 20 },
                        { x: canvasWidth * 0.25, y: canvasHeight * 0.35, width: canvasWidth * 0.15, height: 20 },
                    ],
                    patties: [
                        { x: canvasWidth * 0.35, y: canvasHeight * 0.7, width: 30, height: 30, collected: false },
                        { x: canvasWidth * 0.65, y: canvasHeight * 0.5, width: 30, height: 30, collected: false },
                        { x: canvasWidth * 0.3, y: canvasHeight * 0.3, width: 30, height: 30, collected: false },
                    ],
                    lava: []
                },
                // Level 2: More Krabby Patties
                {
                    platforms: [
                        { x: 0, y: canvasHeight - 40, width: canvasWidth, height: 40 },
                        { x: canvasWidth * 0.1, y: canvasHeight * 0.8, width: canvasWidth * 0.2, height: 20 },
                        { x: canvasWidth * 0.4, y: canvasHeight * 0.6, width: canvasWidth * 0.2, height: 20 },
                        { x: canvasWidth * 0.7, y: canvasHeight * 0.4, width: canvasWidth * 0.2, height: 20 },
                        { x: canvasWidth * 0.4, y: canvasHeight * 0.2, width: canvasWidth * 0.2, height: 20 },
                    ],
                    patties: [
                        { x: canvasWidth * 0.5, y: canvasHeight * 0.55, width: 30, height: 30, collected: false },
                        { x: canvasWidth * 0.8, y: canvasHeight * 0.35, width: 30, height: 30, collected: false },
                        { x: canvasWidth * 0.5, y: canvasHeight * 0.15, width: 30, height: 30, collected: false },
                        { x: canvasWidth * 0.2, y: canvasHeight * 0.75, width: 30, height: 30, collected: false },
                    ],
                    lava: []
                },
                // Level 3: Harder Jumps
                {
                    platforms: [
                        { x: 0, y: canvasHeight - 40, width: canvasWidth, height: 40 },
                        { x: canvasWidth * 0.15, y: canvasHeight * 0.7, width: canvasWidth * 0.1, height: 15 },
                        { x: canvasWidth * 0.4, y: canvasHeight * 0.55, width: canvasWidth * 0.1, height: 15 },
                        { x: canvasWidth * 0.65, y: canvasHeight * 0.4, width: canvasWidth * 0.1, height: 15 },
                        { x: canvasWidth * 0.8, y: canvasHeight * 0.25, width: canvasWidth * 0.1, height: 15 },
                        { x: canvasWidth * 0.3, y: canvasHeight * 0.2, width: canvasWidth * 0.1, height: 15 },
                    ],
                    patties: [
                        { x: canvasWidth * 0.15, y: canvasHeight * 0.65, width: 30, height: 30, collected: false },
                        { x: canvasWidth * 0.4, y: canvasHeight * 0.5, width: 30, height: 30, collected: false },
                        { x: canvasWidth * 0.65, y: canvasHeight * 0.35, width: 30, height: 30, collected: false },
                        { x: canvasWidth * 0.8, y: canvasHeight * 0.2, width: 30, height: 30, collected: false },
                        { x: canvasWidth * 0.3, y: canvasHeight * 0.15, width: 30, height: 30, collected: false },
                    ],
                    lava: []
                },
                // Level 4: Lava
                {
                    platforms: [
                        { x: 0, y: canvasHeight - 40, width: canvasWidth, height: 40 },
                        { x: canvasWidth * 0.15, y: canvasHeight * 0.75, width: canvasWidth * 0.2, height: 20 },
                        { x: canvasWidth * 0.45, y: canvasHeight * 0.6, width: canvasWidth * 0.15, height: 20 },
                        { x: canvasWidth * 0.7, y: canvasHeight * 0.45, width: canvasWidth * 0.2, height: 20 },
                    ],
                    patties: [
                        { x: canvasWidth * 0.2, y: canvasHeight * 0.7, width: 30, height: 30, collected: false },
                        { x: canvasWidth * 0.5, y: canvasHeight * 0.55, width: 30, height: 30, collected: false },
                        { x: canvasWidth * 0.75, y: canvasHeight * 0.4, width: 30, height: 30, collected: false },
                    ],
                    lava: [
                        { x: canvasWidth * 0.3, y: canvasHeight - 40, width: canvasWidth * 0.2, height: 20 },
                        { x: canvasWidth * 0.6, y: canvasHeight - 40, width: canvasWidth * 0.2, height: 20 },
                    ]
                },
                // Level 5: Victory Stage
                {
                    platforms: [
                        { x: 0, y: canvasHeight - 40, width: canvasWidth, height: 40 },
                        { x: canvasWidth * 0.3, y: canvasHeight * 0.6, width: canvasWidth * 0.4, height: 20 },
                    ],
                    patties: [
                        { x: canvasWidth * 0.45, y: canvasHeight * 0.55, width: 30, height: 30, collected: false },
                    ],
                    lava: []
                }
            ];
        }

        function setupLevel() {
            // Reset game state
            score = 0;
            player.x = 50;
            player.y = canvasHeight - 100;
            player.velocityY = 0;
            player.onGround = false;

            // Load a deep copy of platforms, patties, and lava for the current level
            platforms = JSON.parse(JSON.stringify(levels[currentLevelIndex].platforms));
            patties = JSON.parse(JSON.stringify(levels[currentLevelIndex].patties));
            lava = JSON.parse(JSON.stringify(levels[currentLevelIndex].lava));
        }

        // Input handling for keyboard and on-screen controls
        let keys = {};
        const onScreenControls = { left: false, right: false, jump: false };

        // Keyboard events
        window.addEventListener('keydown', (e) => {
            keys[e.key] = true;
        });
        window.addEventListener('keyup', (e) => {
            keys[e.key] = false;
        });
        
        // On-screen control events
        const leftButton = document.getElementById('leftButton');
        const rightButton = document.getElementById('rightButton');
        const jumpButton = document.getElementById('jumpButton');

        leftButton.addEventListener('touchstart', (e) => { e.preventDefault(); onScreenControls.left = true; });
        leftButton.addEventListener('touchend', (e) => { e.preventDefault(); onScreenControls.left = false; });
        leftButton.addEventListener('mousedown', () => { onScreenControls.left = true; });
        leftButton.addEventListener('mouseup', () => { onScreenControls.left = false; });
        leftButton.addEventListener('mouseleave', () => { onScreenControls.left = false; });

        rightButton.addEventListener('touchstart', (e) => { e.preventDefault(); onScreenControls.right = true; });
        rightButton.addEventListener('touchend', (e) => { e.preventDefault(); onScreenControls.right = false; });
        rightButton.addEventListener('mousedown', () => { onScreenControls.right = true; });
        rightButton.addEventListener('mouseup', () => { onScreenControls.right = false; });
        rightButton.addEventListener('mouseleave', () => { onScreenControls.right = false; });

        jumpButton.addEventListener('touchstart', (e) => { 
            e.preventDefault(); 
            if (player.onGround) {
                 player.velocityY = jumpStrength;
                 player.onGround = false;
                 synth.triggerAttackRelease("C4", "8n");
            }
        });
        jumpButton.addEventListener('touchend', (e) => { e.preventDefault(); onScreenControls.jump = false; });
        jumpButton.addEventListener('mousedown', () => { 
            onScreenControls.jump = true; 
        });
        jumpButton.addEventListener('mouseup', () => { onScreenControls.jump = false; });
        jumpButton.addEventListener('mouseleave', () => { onScreenControls.jump = false; });
        
        startButton.addEventListener('click', () => {
            // Play a sound for the button click
            buttonSynth.triggerAttackRelease("G4", "8n");
            
            // Handle different button states
            if (startButton.textContent === "Continue") {
                startGame();
            } else if (startButton.textContent === "Next Level") {
                currentLevelIndex++;
                startGame();
            } else { // "Play Again"
                currentLevelIndex = 0;
                startGame();
            }
        });
        startButton.addEventListener('touchstart', (e) => {
            e.preventDefault();
            // Play a sound for the button click
            buttonSynth.triggerAttackRelease("G4", "8n");
            
            // Handle different button states
            if (startButton.textContent === "Continue") {
                startGame();
            } else if (startButton.textContent === "Next Level") {
                currentLevelIndex++;
                startGame();
            } else { // "Play Again"
                currentLevelIndex = 0;
                startGame();
            }
        });

        // Function to play the new win sound ("Who lives in a pineapple under the sea?")
        function playWinSound() {
            winSynth.triggerAttackRelease("G4", "8n");
            winSynth.triggerAttackRelease("A4", "8n", "+0.2");
            winSynth.triggerAttackRelease("A4", "8n", "+0.4");
            winSynth.triggerAttackRelease("B4", "8n", "+0.6");
            winSynth.triggerAttackRelease("C5", "8n", "+0.8");
            winSynth.triggerAttackRelease("B4", "8n", "+1.0");
            winSynth.triggerAttackRelease("A4", "8n", "+1.2");
            winSynth.triggerAttackRelease("G4", "8n", "+1.4");
            winSynth.triggerAttackRelease("F4", "2n", "+1.6");
        }

        // Function to play a simple game over sound
        function playGameOverSound() {
            gameOverSynth.triggerAttackRelease("C4", "8n");
            gameOverSynth.triggerAttackRelease("A3", "8n", "+0.2");
            gameOverSynth.triggerAttackRelease("F3", "4n", "+0.4");
        }

        function startGame() {
            if (!isGameRunning) {
                isGameRunning = true;
                messageBox.classList.add('hidden');
                setupLevel();
                gameLoop();
            }
        }

        function showMessage(title, subtitle, buttonText) {
            isGameRunning = false;
            messageBox.querySelector('h1').textContent = title;
            messageBox.querySelector('p:nth-of-type(1)').textContent = subtitle;
            if (buttonText) {
                startButton.textContent = buttonText;
                startButton.classList.remove('loading-button');
            } else {
                startButton.classList.add('loading-button');
            }

            // Updated logic: Only show the logo for the specific "Oh no!" plot screen
            if (title === "Oh no!") {
                pattyLogo.style.display = 'block';
            } else {
                pattyLogo.style.display = 'none';
            }

            messageBox.classList.remove('hidden');
        }

        function gameLoop() {
            if (!isGameRunning) return;

            update();
            draw();
            
            // Check for level completion
            if (score === patties.length) {
                if (currentLevelIndex < levels.length - 1) {
                    showMessage("Level Complete!", "You collected all the Krabby Patties!", "Next Level");
                } else {
                    playWinSound();
                    showMessage("You Win!", "You've completed all levels!", "Play Again");
                }
                return;
            }
            
            // Check for falling off the screen
            if (player.y > canvasHeight) {
                playGameOverSound();
                showMessage("Game Over", "You fell!", "Play Again");
                return;
            }
            
            requestAnimationFrame(gameLoop);
        }

        function update() {
            // Horizontal movement using both keyboard and on-screen controls
            player.velocityX = 0;
            if (keys['ArrowLeft'] || onScreenControls.left) {
                player.velocityX = -horizontalSpeed;
            }
            if (keys['ArrowRight'] || onScreenControls.right) {
                player.velocityX = horizontalSpeed;
            }
            player.x += player.velocityX;

            // Apply gravity
            player.velocityY += gravity;
            player.y += player.velocityY;

            // Check for collision with lava first, as it's a higher priority
            for (let i = 0; i < lava.length; i++) {
                const lavaBlock = lava[i];
                if (player.x < lavaBlock.x + lavaBlock.width &&
                    player.x + player.width > lavaBlock.x &&
                    player.y < lavaBlock.y + lavaBlock.height &&
                    player.y + player.height > lavaBlock.y) {
                    
                    playGameOverSound();
                    showMessage("Game Over", "You fell into the lava!", "Play Again");
                    return;
                }
            }
            
            // Then check for collision with platforms
            player.onGround = false;
            for (let i = 0; i < platforms.length; i++) {
                const platform = platforms[i];
                // AABB collision check
                if (player.x < platform.x + platform.width &&
                    player.x + player.width > platform.x &&
                    player.y < platform.y + platform.height &&
                    player.y + player.height > platform.y) {

                    // If the player is moving downwards, and their feet were above the platform last frame
                    if (player.velocityY >= 0 && player.y + player.height - player.velocityY <= platform.y) {
                        // Snap the player to the top of the platform
                        player.y = platform.y - player.height;
                        player.velocityY = 0;
                        player.onGround = true;
                    }
                }
            }

            // Jumping using both keyboard and on-screen controls
            if ((keys['ArrowUp'] || onScreenControls.jump) && player.onGround) {
                player.velocityY = jumpStrength;
                player.onGround = false;
                // Play a jumping sound
                synth.triggerAttackRelease("C4", "8n");
            }
            
            // Collect Krabby Patties
            for (let i = 0; i < patties.length; i++) {
                const patty = patties[i];
                if (!patty.collected && 
                    player.x < patty.x + patty.width &&
                    player.x + player.width > patty.x &&
                    player.y < patty.y + patty.height &&
                    player.y + player.height > patty.y) {
                    
                    patty.collected = true;
                    score++;
                    // Play a Krabby Patty collection sound
                    pattySynth.triggerAttackRelease("C3", "16n");
                    pattySynth.triggerAttackRelease("F3", "16n", "+0.05");
                }
            }
        }

        function draw() {
            // Clear canvas
            ctx.clearRect(0, 0, canvasWidth, canvasHeight);

            // Draw the player image if it has loaded
            if (isPlayerImageLoaded) {
                ctx.drawImage(playerImage, player.x, player.y, player.width, player.height);
            } else {
                // Fallback to a simple yellow square if the image failed to load
                ctx.fillStyle = '#f1c40f';
                ctx.fillRect(player.x, player.y, player.width, player.height);
            }

            // Draw platforms
            ctx.fillStyle = '#ecf0f1'; // Platform color: Light grey
            platforms.forEach(platform => {
                ctx.fillRect(platform.x, platform.y, platform.width, platform.height);
            });

            // Draw lava
            ctx.fillStyle = '#e74c3c'; // Lava color: Red
            lava.forEach(lavaBlock => {
                ctx.fillRect(lavaBlock.x, lavaBlock.y, lavaBlock.width, lavaBlock.height);
            });

            // Draw Krabby Patties
            patties.forEach(patty => {
                if (!patty.collected) {
                    if (isPattyImageLoaded) {
                        ctx.drawImage(pattyImage, patty.x, patty.y, patty.width, patty.height);
                    } else {
                        // Fallback to a brown square if the Krabby Patty image failed to load
                        ctx.fillStyle = '#8B4513';
                        ctx.fillRect(patty.x, patty.y, patty.width, patty.height);
                    }
                }
            });
            
            // Draw score and level
            ctx.fillStyle = '#ecf0f1';
            ctx.font = '24px "Inter"';
            ctx.textAlign = 'left';
            ctx.fillText(`Krabby Patties: ${score} / ${patties.length}`, 10, 30);
            ctx.textAlign = 'right';
            ctx.fillText(`Level: ${currentLevelIndex + 1} / ${levels.length}`, canvasWidth - 10, 30);
        }
        
        // Initial setup
        setCanvasSize();
        defineLevels();
        showMessage("Loading...", "Please wait...", "");
    </script>
</body>
</html>
